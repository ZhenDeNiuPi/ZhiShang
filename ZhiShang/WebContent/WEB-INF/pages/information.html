<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link href="../css/bootstrap.min.css" rel="stylesheet">
	<title>首页</title>
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/bootstrap-treeview.min.css" rel="stylesheet">
    <link href="../css/bootstrap-dialog.css" rel="stylesheet">
    <link href="../css/cropper.css" rel="stylesheet">
    <script type="text/javascript" src="../js/cropper.js"></script>
    <script type="text/javascript" src="../js/jquery-cropper.js"></script>
    <script type="text/javascript" src="../js/bootstrap-treeview.min.js"></script>
    <script type="text/javascript" src="../js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../js/bootstrap-dialog.js"></script>
    <script type="text/javascript" src="js/properties.js"></script>
    <script type="text/javascript" src="js/globalAjax.js"></script>
</head>
<body>
<div id="consoleForm">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        
	        <h4 class="modal-title" id="myModalLabel"
	        align="center">公司信息管理</h4>
	      </div>
	      <div class="modal-body">
	       	<!-- 表单开始 -->
			<form id="welcomeForm" action="" class="form-horizontal" role="form" autocomplete="off">
			  <input type="hidden" id="id" name="u.id" >
			  <input type="hidden" id="picid">
			  <div class="form-group">
			    <label for="hot" class="col-sm-4 control-label">热线:</label>
			    <div class="col-sm-8">
			      <input type="text" class="form-control" maxlength="20" 
			       id="hot" name="u.hot" placeholder="输入热线">
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="address" class="col-sm-4 control-label">地址:</label>
			    <div class="col-sm-8">
			      <input type="text" class="form-control" maxlength="30"
			       id="address" name="u.address" placeholder="输入地址">
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="email" class="col-sm-4 control-label">邮箱:</label>
			    <div class="col-sm-8">
			      <input type="text" class="form-control" maxlength="30"
			       id="email" name="u.email" placeholder="输入邮箱">
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="phone" class="col-sm-4 control-label">固话:</label>
			    <div class="col-sm-8">
			      <input type="text" class="form-control" maxlength="20" 
			       id="phone" name="u.phone" placeholder="输入固话">
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="mobile" class="col-sm-4 control-label">手机:</label>
			    <div class="col-sm-8">
			      <input type="text" class="form-control" maxlength="20" 
			       id="mobile" name="u.mobile" placeholder="输入手机">
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="four" class="col-sm-4 control-label">四个优势:</label>
			    <div class="col-sm-2">
			      <input type="text" class="form-control" maxlength="20" 
			       id="four1" name="u.four1" placeholder="一">
			    </div>
			    <div class="col-sm-2">
			      <input type="text" class="form-control" maxlength="20" 
			       id="four2" name="u.four2" placeholder="二">
			    </div>
			    <div class="col-sm-2">
			      <input type="text" class="form-control" maxlength="20" 
			       id="four3" name="u.four3" placeholder="三">
			    </div>
			    <div class="col-sm-2">
			      <input type="text" class="form-control" maxlength="20" 
			       id="four4" name="u.four4" placeholder="四">
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="about" class="col-sm-4 control-label">关于我们:</label>
			    <div class="col-sm-8">
			      <textarea class="form-control" maxlength="300" 
			       id="about" name="u.about" placeholder="输入关于我们"></textarea>
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="idea" class="col-sm-4 control-label">配图:</label>
			    <div class="col-sm-8">
			      <img src="../user/getUsPic?s="+Math.random()  width="100%" id="usPic" 
			      onclick="opera(this)"/>
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="idea" class="col-sm-4 control-label">公司理念:</label>
			    <div class="col-sm-8">
			      <textarea class="form-control" maxlength="300" 
			       id="idea" name="u.idea" placeholder="输入公司理念"></textarea>
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="idea" class="col-sm-4 control-label">配图:</label>
			    <div class="col-sm-8">
			      <img src="../user/getPic?s="+Math.random()  width="100%" id="pic" 
			      onclick="opera(this)"/>
			    </div>
			  </div>
			</form>
	       	<!-- 表单结束 -->
	      </div>
	      <div class="modal-footer">
	        <button type="button" id="submitButton" class="btn btn-default" data-dismiss="modal">修改</button>
	        <button type="button" id="clearButton" class="btn btn-default" data-dismiss="modal">重置</button>
	      </div>
	    </div>
</div>	
<!-- 模态框   信息删除确认 -->
<div class="modal fade" id="reuploadOrDel">
    <div class="modal-dialog">
        <div class="modal-content message_align">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                    aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title">提示</h4>
            </div>
            <div class="modal-body">
                <!-- 隐藏需要删除的id -->
                <input type="hidden" id="deleteHaulId" />
                <p>上传</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                    data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary"
                    id="reuploadBut">上传</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="changeModal" tabindex="-1" role="dialog" aria-hidden="true" style="overflow: auto">
<div class="modal-dialog-lg">
    <div class="modal-content" style="height:100%">
        <div class="row">
        <div class="col-sm-12 text-center">
            <label for="input" class="btn btn-danger" id="">
            <span>选择图片</span>
            <input type="file" id="input" class="sr-only">
            </label>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-6" id="photodiv">
            <img src="" id="photo" />
        </div>
        <div class="col-sm-6  text-center">
            <div id="prediv">
                <div class="img-preview" id="pre"></div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-default"
            data-dismiss="modal">取消</button>
        <button class="btn btn-primary" onclick="crop()">确定</button>
    </div>
    </div>
</div>
</div> 
<script type="text/javascript">
getData();
$("#clearButton").bind("click",function(){
	getData();
});
function getData(){
	$.ajax({
		type:"post",
		url:"../user/getData",
		data:"",
		dataType:"json",
		error:function(XMLHttpRequest, textStatus, errorThrown){
			 BootstrapDialog.alert({title:"提示信息",message:"网络错误！"});
		 },
		success:function(result){
			if(result){
				$("#id").val(result["id"]);
				$("#hot").val(result["hot"]);
				$("#address").val(result["address"]);
				$("#email").val(result["email"]);
				$("#phone").val(result["phone"]);
				$("#mobile").val(result["mobile"]);
				$("#about").val(result["about"]);
				$("#idea").val(result["idea"]);
				$("#four1").val(result["four1"]);
				$("#four2").val(result["four2"]);
				$("#four3").val(result["four3"]);
				$("#four4").val(result["four4"]);
			}else BootstrapDialog.alert({title:"提示信息",message:result["errormessage"]});
		}
	});
}
$("#submitButton").bind("click",function(){
	$.ajax({
		type:"post",
		url:"../user/update",
		data:$("#welcomeForm").serialize(),
		dataType:"json",
		error:function(XMLHttpRequest, textStatus, errorThrown){
			 BootstrapDialog.alert({title:"提示信息",message:"网络错误！"});
		 },
		success:function(result){
			if(result["num"]=="1"){
				BootstrapDialog.alert({title:"提示信息",message:"修改成功！"});
			}else BootstrapDialog.alert({title:"提示信息",message:result["errormessage"]});
		}
	});
});

function opera(img){
	var id = $(img).attr("id");
	$("#picid").val(id);
	$("#reuploadOrDel").modal('show');
}

$("#reuploadBut").click(function() {
	$("#reuploadOrDel").modal('hide');
	open();
});

function open(){
	$("#photodiv").html('<img src="" id="photo" />');
	$("#prediv").html('<div class="img-preview" id="pre"></div>');
	var swidth = $(document).width();
	$("#photo").width(swidth/2);
	$("#photo").height(swidth/2-swidth/8);
	$("#pre").width(swidth/2);
	$("#pre").height(swidth/2-swidth/8);
	initCropper($('#photo'),$('#input'));
	$("#changeModal").modal('show');
}
var initCropper = function (img, input){
    var $image = img;
    var options = {
        //aspectRatio: 1, // 纵横比
        viewMode: 2,
        preview: '.img-preview' // 预览图的class名
    };
    $image.cropper(options);
    var $inputImage = input;
    var uploadedImageURL;
    if (URL) {
        // 给input添加监听
        $inputImage.change(function () {
            var files = this.files;
            var file;
            if (!$image.data('cropper')) {
                return;
            }
            if (files && files.length) {
                file = files[0];
                // 判断是否是图像文件
                if (/^image\/\w+$/.test(file.type)) {
                    // 如果URL已存在就先释放
                    if (uploadedImageURL) {
                        URL.revokeObjectURL(uploadedImageURL);
                    }
                    uploadedImageURL = URL.createObjectURL(file);
                    // 销毁cropper后更改src属性再重新创建cropper
                    $image.cropper('destroy').attr('src', uploadedImageURL).cropper(options);
                    $inputImage.val('');
                } else {
                  window.alert('请选择一个图像文件！');
              }
          }
      });
    } else {
        $inputImage.prop('disabled', true).addClass('disabled');
    }
}
var crop = function(){
	var picid = $("#picid").val();
	var uploadUrl = "../user/uploadPic";
	var getUrl = "../user/getPic?s=";
	if(picid == "usPic") uploadUrl = "../user/uploadUsPic";
	if(picid == "usPic") getUrl = "../user/getUsPic?s=";
    var cas = $('#photo').cropper('getCroppedCanvas',{
    	  fillColor: '#fff',
    	  imageSmoothingEnabled: false,
    	  imageSmoothingQuality: 'high'
    });
    var photo = cas.toDataURL('image/jpeg');
    cas.toBlob(function (e) {
        console.log(e);  //生成Blob的图片格式
        e.name="temp.jpeg";
        var formData = new FormData();
        formData.append('croppedImage', e);
        console.log(e);
        console.log(formData);
        $.ajax(uploadUrl, {
    	    method: "POST",
    	    data: formData,
    	    processData: false,
    	    contentType: false,
    	    success: function () {
                $("#"+picid).attr('src', getUrl+Math.random());
                $('#changeModal').modal('hide');
	        	console.log('Upload success');
    	    },
    	    error: function () {
    	        console.log('Upload error');
    	    }
        });
    },'image/jpeg')
}
</script>
</body>
</html>