<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<title>首页</title>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-treeview.min.css" rel="stylesheet">
    <link href="css/bootstrap-dialog.css" rel="stylesheet">
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-table.js"></script>
    <script type="text/javascript" src="js/bootstrap-treeview.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-dialog.js"></script>
    <script type="text/javascript" src="js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="js/properties.js"></script>
    <script type="text/javascript" src="js/globalAjax.js"></script>
</head>
<body>
    <div id="toolbar">
        <button id="remove" class="btn btn-danger">
            <i class="glyphicon glyphicon-remove"></i> 批量取消
        </button>
        <button id="update" class="btn btn-success">
            <i class="glyphicon glyphicon-pencil"></i> 编辑订阅
        </button>
        <button id="add" class="btn btn-info" >
            <i class="glyphicon glyphicon-plus"></i> 添加订阅
        </button>
        <button id="condis" class="btn btn-warning" data-toggle="modal"
		             data-target="#searchModal">
            <i class="glyphicon glyphicon-search"></i> 条件查询
        </button>
        <button id="clear" class="btn btn-primary">
            <i class="glyphicon glyphicon-refresh"></i> 重置查询
        </button>
    </div>
    <table id="table" data-toolbar="#toolbar">
    </table>
</div>
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	  <div class="modal-dialog" style="width:600px;">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
	        <h4 class="modal-title" id="myModalLabel"
	        align="center">添加订阅</h4>
	      </div>
	      <div class="modal-body">
	       	<!-- 表单开始 -->
			<form id="addForm" action="" class="form-horizontal" role="form">
				<input type="hidden" id="id" name="f.id"/>
				<input type="hidden" id="user_id" name="f.user_id"/>
			  <div class="form-group">
			    <label for="fund_id" class="col-sm-3 control-label">基金编码</label>
			    <div class="col-sm-9">
			      <input type="number" class="form-control"
			       id="fund_id" name="f.fund_id" placeholder="输入基金编码" maxlength="10" onblur="getFundName(this)">
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="fund_name" class="col-sm-3 control-label">基金名称</label>
			    <div class="col-sm-9">
			      <input type="text" class="form-control"
			       id="fund_name" name="fund_name" placeholder="输入基金编码" onfocus=this.blur()>
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="position_point" class="col-sm-3 control-label">持仓份额</label>
			    <div class="col-sm-9">
			      <input type="number" class="form-control"
			       id="position_point" name="f.position_point" placeholder="输入总持仓份额" maxlength="15">
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="position_price" class="col-sm-3 control-label">持仓成本(元)</label>
			    <div class="col-sm-9">
			      <input type="number" class="form-control"
			       id="position_price" name="f.position_price" placeholder="输入总持仓成本(持仓份额*每份额成本)" maxlength="15">
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="callback" class="col-sm-3 control-label">止盈回调(%)</label>
			    <div class="col-sm-9">
			      <input type="number" class="form-control"
			       id="callback" name="f.callback" placeholder="输入止盈回调" maxlength="2">
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="enough" class="col-sm-3 control-label">止盈率(%)</label>
			    <div class="col-sm-9">
			      <input type="number" class="form-control"
			       id="enough" name="f.enough" placeholder="输入止盈率" maxlength="2">
			    </div>
			  </div>
			</form>
	       	<!-- 表单结束 -->
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
	        <button type="button" id="addButton" class="btn btn-primary">保存</button>
	      </div>
	    </div>
	  </div>
	</div>
	<div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
	        <h4 class="modal-title" id="myModalLabel"
	        align="center">条件查询</h4>
	      </div>
	      <div class="modal-body">
	       	<!-- 表单开始 -->
			<form id="searchForm" action="" class="form-horizontal" role="form">
			  <div class="form-group">
			    <label for="timeStrBegin" class="col-sm-3 control-label">订阅时间起始</label>
			    <div class="col-sm-3">
			      <input type="text" class="form-control"
			       id="timeStrBegin" name="timeStrBegin" readonly="readonly"  placeholder="选择时间起始">
			    </div>
			    <label for="timeStrBegin" class="col-sm-3 control-label">订阅时间截止</label>
			    <div class="col-sm-3">
			      <input type="text" class="form-control"
			       id="timeStrEnd" name="timeStrEnd" readonly="readonly"  placeholder="选择时间截止">
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="searchFund" class="col-sm-3 control-label">基金模糊检索</label>
			    <div class="col-sm-9">
			      <input type="text" class="form-control"
			       id="searchFund" name="searchFund"  placeholder="输入基金编码或名称" maxlength="15"/>
			    </div>
			  </div>
			</form>
	       	<!-- 表单结束 -->
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
	        <button type="button" id="clearButton" class="btn btn-primary">重置</button>
	        <button type="button" id="searchButton" class="btn btn-primary">查询</button>
	      </div>
	    </div>
	  </div>
	</div>
</body>
<script type="text/javascript">
$("#add").bind("click",function(){
	document.getElementById("addForm").reset();
	$("#fund_id").removeAttr("onfocus");
	$("#myModalLabel").text("添加订阅");
	$("#myModal").modal('show');
});
$("#addButton").bind("click",function(){
	var url = "";
	var text = $("#myModalLabel").text();
	if(text=="添加订阅")
		url = "followfund/addData";
	else
		url = "followfund/updateData";
	
    $.ajax({
		type:"post",
		url:url,
		data:$("#addForm").serialize(),
		dataType:"json",
		error:function(XMLHttpRequest, textStatus, errorThrown){
			 BootstrapDialog.alert({title:"提示信息",message:"网络错误！"});
		 },
		success:function(result){
			if(result["num"]==1){
				$("#table").bootstrapTable(  
			              "refresh",  
			              {  
			                  url:"followfund/getDatas"
			              }  
			      ); 	
				BootstrapDialog.alert({title:"提示信息",message:"保存成功！"});
				$("#myModal").modal('hide');
			}
			else BootstrapDialog.alert({title:"提示信息",message:result["errormessage"]});
		}
	});
});
function getFundName(sel){
	var id = $.trim($(sel).val());
	if(id == undefined || id == null || id == "") {
		$("#fund_name").val("");
		return ;
	}
    $.ajax({
		type:"post",
		url:"followfund/getFundName",
		data:{"id":id},
		dataType:"json",
		error:function(XMLHttpRequest, textStatus, errorThrown){
			 BootstrapDialog.alert({title:"提示信息",message:"网络错误！"});
		 },
		success:function(result){
			if(result["num"]==1) $("#fund_name").val(result["name"]);
			else $("#fund_name").val("");
		}
	});
}
function queryParams(params) {  //配置参数 
	var temp = {   //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的  
  	"pageSize": params.pageSize,   //页面大小  
 	"pageNumber": params.pageNumber,  //页码    
	"follow_time%t>":$("#timeStrBegin").val(),
	"follow_time%t<":$("#timeStrEnd").val(),
	"f.fund_id`t.name%s~":$("#searchFund").val(),
  	"sortName": params.sortName,  //排序列名  
  	"sortOrder": params.sortOrder//排位命令（desc，asc）  
	};  
	return temp;  
} 
    $("#clearButton").bind("click",function(){
    	document.getElementById("searchForm").reset();
    });
    $("#clear").bind("click",function(){
    	document.getElementById("searchForm").reset();
    	$("#table").bootstrapTable(  
	              "refresh",  
	              {  
	                  url:"followfund/getDatas"
	              }  
	      ); 
    });
    $("#searchButton").bind("click",function(){
    	
    	$("#table").bootstrapTable(  
	              "refresh",  
	              {   
	                  url:"followfund/getDatas"
	              }  
	      ); 
		$("#searchModal").modal('hide');
    });
    $("#remove").bind("click",function(){
    	var datas = $("#table").bootstrapTable("getSelections");
    	if(datas.length!=0){
    		var str = "";
    		for(var i=0;i<datas.length;i++){
    			str+=datas[i]["id"]+",";
    		}
    		str = str.substring(0,str.length-1);
    		$.ajax({
        		type:"post",
        		url:"followfund/deleteDatas",
        		data:{idStr:str},
        		dataType:"json",
        		error:function(XMLHttpRequest, textStatus, errorThrown){
        			 BootstrapDialog.alert({title:"提示信息",message:"网络错误！"});
        		 },
        		success:function(result){
        			$("#table").bootstrapTable(  
        		              "refresh",  
        		              {  
        		                  url:"followfund/getDatas"
        		              }  
        		      ); 	
        			BootstrapDialog.alert({title:"提示信息",message:"成功取消"+result["num"]+"条订阅！"});
        		}
    		}); 
    	}else{
    		BootstrapDialog.alert({title:"提示信息",message:"你还没有选择数据！"});
    	}
    })
$("#update").bind("click",function(){
	document.getElementById("addForm").reset();
	$("#fund_id").attr("onfocus","this.blur()");
	var datas = $("#table").bootstrapTable("getSelections");
	if(datas.length == 1){
		var rowData = datas[0];
		$.ajax({
    		type:"post",
    		url:"followfund/getData",
    		data:{"id":rowData['id']},
    		dataType:"json",
    		error:function(XMLHttpRequest, textStatus, errorThrown){
    			 BootstrapDialog.alert({title:"提示信息",message:"网络错误！"});
    		 },
    		success:function(result){
    			$("#id").val(result['id']);
    			$("#user_id").val(result['user_id']);
    			$("#fund_id").val(result['fund_id']);
    			$("#fund_name").val(result['name']);
    			$("#position_point").val(result['position_point']);
    			$("#position_price").val(result['position_price']);
    			$("#callback").val(result['callback']);
    			$("#enough").val(result['enough']);
    			$("#myModalLabel").text("编辑订阅");
    			$("#myModal").modal('show');
    		}
		});
	}else{
		BootstrapDialog.alert({title:"提示信息",message:"必须选择一条订阅！"});
	}
})
$('#timeStrBegin').datetimepicker({
	format: 'yyyy-mm-dd',      /*此属性是显示顺序，还有显示顺序是mm-dd-yyyy*/
	minView:'month',
	todayBtn:true,
	todayHighlight:true,
	autoclose:true,
	startDate:'2018-01-01',
	forceParse:false
	});
$('#timeStrEnd').datetimepicker({
	format: 'yyyy-mm-dd',      /*此属性是显示顺序，还有显示顺序是mm-dd-yyyy*/
	minView:'month',
	todayBtn:true,
	todayHighlight:true,
	autoclose:true,
	startDate:'2018-01-01',
	forceParse:false
	});
$('#table').bootstrapTable({
    method: 'post',
    contentType: "application/x-www-form-urlencoded",
    url: "followfund/getDatas",//这个接口需要处理bootstrap table传递的固定参数
    toolbar: '#toolbar',    //工具按钮用哪个容器
    striped: true,      //是否显示行间隔色
    cache: false,      //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
    pagination: true,     //是否显示分页（*）
    onlyInfoPagination: false,
    sortable: true,      //是否启用排序
    sortOrder: "desc",     //排序方式
    sortName:"follow_time",
    dataType: "json",
    pageNumber:1,      //初始化加载第一页，默认第一页
    pageSize: 10,      //每页的记录行数（*）
    pageList: [10, 25, 50, 100],  //可供选择的每页的行数（*）
    queryParamsType:'', //默认值为 'limit' ,在默认情况下 传给服务端的参数为：offset,limit,sort
                        // 设置为 ''  在这种情况下传给服务器的参数为：pageSize,pageNumber

    queryParams: queryParams,//前端调用服务时，会默认传递上边提到的参数，如果需要添加自定义参数，可以自定义一个函数返回请求参数
    sidePagination: "server",   //分页方式：client客户端分页，server服务端分页（*）
    //search: true,      //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
    //strictSearch: true,
    //showColumns: true,     //是否显示所有的列
    //showRefresh: true,     //是否显示刷新按钮
    //showHeader : true,
    //showPaginationSwitch:true,
    //showColumns : true,
    minimumCountColumns: 2,    //最少允许的列数
    clickToSelect: false,    //是否启用点击选中行
    //searchOnEnterKey: true,
    /* height: $(window).height(), */
    columns: [{
        field: 'state',
        checkbox: true,
        width:'5%',
        align: 'left'
    },{
        field: 'id',
        title: 'id',
        align: 'center',
        visible:false
    },{
        field: 'preprice',
        title: 'preprice',
        align: 'center',
        visible:false
    },{
        field: 'net',
        title: 'net',
        align: 'center',
        visible:false
    },{
        field: 'fund_id',
        title: '基金编码',
        align: 'center',
        width:'5%',
        sortable: true
    },{
        field: 'name',
        title: '基金名称',
        align: 'center',
        width:'15%',
        sortable: true
    },{
        field: 'fTime',
        title: '订阅时间',
        align: 'center',
        width:'10%',
        sortable: true
    },{
        field: 'position_point',
        title: '持仓份额',
        align: 'center',
        width:'10%',
        sortable: true
    },{
        field: 'position_price',
        title: '持仓成本',
        align: 'center',
        width:'10%',
        sortable: true,
        formatter: function (value, row, index) {
        	if(value!=null)
        		return value+"元";
        	else
        		return "-";
        }
    },{
        field: 'callback',
        title: '止盈回调',
        align: 'center',
        width:'8%',
        sortable: true,
        formatter: function (value, row, index) {
        	if(value!=null)
        		return value+"%";
        	else
        		return "-";
        }
    },{
        field: 'enough',
        title: '止盈率',
        align: 'center',
        width:'8%',
        sortable: true,
        formatter: function (value, row, index) {
        	if(value!=null)
        		return value+"%";
        	else
        		return "-";
        }
    },{
        field: '收益率',
        title: '收益率',
        align: 'center',
        width:'8%',
        formatter: function (value, row, index) {
        	var position_point = row['position_point'];
        	var position_price = row['position_price'];
        	var net = row['net']
        	if((!position_point > 0)||(!position_price > 0)){
        		return "持仓信息待完善";
        	}
        	if(net == ""||net==null) net = row['preprice'];
        	if(net == ""){
        		return "上期净值暂无";
        	}
        	var x = (position_point*net-position_price)/position_price;
        	return Math.round(x * 10000) / 100+"%";
        }
    },{
        field: '收益',
        title: '收益',
        align: 'center',
        width:'8%',
        formatter: function (value, row, index) {
        	var position_point = row['position_point'];
        	var position_price = row['position_price'];
        	var net = row['net']
        	if((!position_point > 0)||(!position_price > 0)){
        		return "持仓信息待完善";
        	}
        	if(net == ""||net==null) net = row['preprice'];
        	if(net == ""){
        		return "上期净值暂无";
        	}
        	var x = position_point*net-position_price;
        	return Math.round(x * 100) / 100+"元";
        }
    } ]
});
</script>
</html>